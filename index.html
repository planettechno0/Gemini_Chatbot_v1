<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Gemini Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #f7fafc; border-radius: 10px; }
        #chat-history::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        #chat-history::-webkit-scrollbar-thumb:hover { background: #718096; }
        .modal.flex { display: flex; }
        .modal.hidden { display: none; }
        .modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .chat-bubble { max-width: 85%; word-wrap: break-word; }
        header { position: sticky; top: 0; z-index: 50; }
        .control-icon { cursor: pointer; opacity: 0.6; transition: opacity 0.2s ease-in-out; }
        .control-icon:hover { opacity: 1; }
        pre { background-color: #2d3748; color: #e2e8f0; padding: 1em; border-radius: 0.5em; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; margin: 0.5em 0; }
        pre code { background-color: transparent; color: inherit; padding: 0; }
        code:not(pre > code) { background-color: #e2e8f0; color: #2d3748; padding: 0.2em 0.4em; border-radius: 0.3em; font-size: 0.9em; }
        .image-preview-container { position: relative; max-width: 200px; margin-bottom: 0.5rem; }
        .image-preview-container img { max-width: 100%; max-height: 150px; border-radius: 0.5em; border: 1px solid #cbd5e0; }
        .remove-image-btn { position: absolute; top: -8px; right: -8px; background-color: rgba(255,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 1px solid white; }
        .log-entry { border-bottom: 1px solid #eee; padding: 4px 0; font-size: 0.85rem; }
        .log-entry.error { color: red; }
        .log-entry.info { color: blue; }
        .log-entry.warn { color: orange; }
        
        /* Styling for message action buttons */
        .message-wrapper { /* New wrapper for message bubble and its actions */
            display: flex;
            flex-direction: column;
            margin-bottom: 0.75rem; /* Replaces mb-3 on old messageWrapper */
        }
        .message-wrapper.user {
            align-items: flex-end;
        }
        .message-wrapper.model {
            align-items: flex-start;
        }
        .message-actions {
            display: flex;
            gap: 0.25rem; /* gap-1 */
            margin-top: 0.25rem; /* mt-1 */
        }
        .message-actions button { 
            opacity: 0; 
            transition: opacity 0.2s ease-in-out;
            padding: 0.125rem; /* p-0.5 */
        }
        .message-wrapper:hover .message-actions button { /* Show on wrapper hover */
            opacity: 0.6; 
        }
        .message-actions button:hover { 
            opacity: 1; 
        }

    </style>
</head>
<body class="font-sans bg-gray-100">
    <div class="min-h-screen flex flex-col">
        <header class="bg-white shadow-md">
            <div class="max-w-3xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Gemini Chatbot</h1>
                <div class="flex items-center space-x-2">
                    <button id="clear-chat-btn" title="New Chat" class="control-icon text-gray-600 hover:text-red-600 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    </button>
                    <button id="settings-btn" title="Settings" class="control-icon text-gray-600 hover:text-blue-600 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 1.905c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.184-.582.496-.646.87l-.212 1.282c-.09.542-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 010-1.905c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.184.582-.496.644-.87l.214-1.282z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col py-4 px-4 sm:px-6 lg:px-8 max-w-3xl w-full mx-auto">
            <div id="chat-history" class="bg-white shadow-inner overflow-y-auto flex-1 p-4 rounded-lg mb-3" style="height: calc(100vh - 250px);"></div>
            <div id="loading-indicator" class="hidden self-center my-1 text-gray-600 items-center text-sm">
                <svg class="animate-spin h-4 w-4 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Thinking...</span>
            </div>
            <div id="copy-feedback" class="self-center text-xs text-green-600 mb-1 h-4"></div>
            <div id="image-preview-area" class="mb-2"></div>
            <div class="mt-auto flex gap-2 items-center">
                <label for="image-upload" title="Attach Image" class="control-icon text-gray-500 hover:text-blue-600 p-2.5 rounded-md border border-gray-300 hover:border-blue-500 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                </label>
                <input type="file" id="image-upload" accept="image/*" class="hidden">
                <input id="message-input" type="text" class="flex-1 border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="Type your message or drop an image...">
                <button id="send-btn" class="bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 shadow-sm disabled:opacity-60 disabled:cursor-not-allowed">
                    Send
                </button>
            </div>
        </main>

        <div id="settings-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-[100] p-4">
            <div class="modal-content bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg transform scale-95 opacity-0" id="settings-modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">Settings</h2>
                    <button id="close-settings-btn" title="Close settings" class="control-icon text-gray-500 hover:text-gray-700 p-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
                <label for="api-key-input" class="block mb-1 text-sm font-medium text-gray-700">Gemini API Key:</label>
                <input id="api-key-input" type="password" class="w-full border border-gray-300 p-2.5 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="Enter your Gemini API key">
                
                <label for="model-select" class="block mb-1 text-sm font-medium text-gray-700">Model:</label>
                <select id="model-select" class="w-full border border-gray-300 p-2.5 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm bg-white appearance-none">
                    <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash Preview 05-20</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                    <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite</option>
                    <option value="ggemma-3-27b-it">gemma3 27b it</option>
                </select>

                <label for="custom-instructions-input" class="block mb-1 text-sm font-medium text-gray-700">Custom Instructions (System Prompt):</label>
                <textarea id="custom-instructions-input" rows="3" class="w-full border border-gray-300 p-2.5 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="e.g., Always respond in a friendly tone."></textarea>
                
                <div class="flex justify-between items-center">
                    <button id="view-logs-btn" class="text-sm text-blue-600 hover:underline">View Logs & Test</button>
                    <button id="save-settings-btn" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 shadow-md">Save Settings</button>
                </div>
            </div>
        </div>

        <div id="confirm-clear-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-[101] p-4">
            <div class="modal-content bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95 opacity-0">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">New Chat Options</h2>
                <p class="text-gray-600 mb-6">How would you like to start a new chat?</p>
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                    <button id="cancel-clear-btn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 w-full sm:w-auto">Cancel</button>
                    <button id="confirm-clear-action-btn" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 w-full sm:w-auto">Clear & New</button>
                    <button id="save-new-btn" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 w-full sm:w-auto">Save & New</button>
                </div>
            </div>
        </div>

        <div id="logs-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-[102] p-4">
            <div class="modal-content bg-white flex flex-col p-5 rounded-xl shadow-2xl w-full max-w-2xl h-3/4 transform scale-95 opacity-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Application Logs</h2>
                    <button id="close-logs-btn" title="Close logs" class="control-icon text-gray-500 hover:text-gray-700 p-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
                <div id="log-output-area" class="flex-1 overflow-y-auto border border-gray-300 bg-gray-50 p-3 rounded-md text-xs mb-4"></div>
                <div class="flex justify-between items-center">
                    <button id="run-tests-btn" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 text-sm">Run Basic Tests</button>
                    <button id="copy-logs-btn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 text-sm">Copy Logs</button>
                </div>
            </div>
        </div>
         <div id="edit-message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-[101] p-4">
            <div class="modal-content bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg transform scale-95 opacity-0">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Edit Message</h2>
                <textarea id="edit-message-textarea" rows="5" class="w-full border border-gray-300 p-2.5 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-edit-btn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button id="save-edit-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save Edit</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- DOM Elements ---
        const chatHistoryDisplay = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const copyFeedback = document.getElementById('copy-feedback');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreviewArea = document.getElementById('image-preview-area');

        // Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const settingsModalContent = document.getElementById('settings-modal-content');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');
        const customInstructionsInput = document.getElementById('custom-instructions-input');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const viewLogsBtn = document.getElementById('view-logs-btn');

        // Clear Chat Modal
        const confirmClearModal = document.getElementById('confirm-clear-modal');
        const confirmClearModalContent = confirmClearModal.querySelector('.modal-content');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');
        const confirmClearActionBtn = document.getElementById('confirm-clear-action-btn');
        const saveNewBtn = document.getElementById('save-new-btn'); // New button

        // Logs Modal
        const logsModal = document.getElementById('logs-modal');
        const logsModalContent = logsModal.querySelector('.modal-content');
        const closeLogsBtn = document.getElementById('close-logs-btn');
        const logOutputArea = document.getElementById('log-output-area');
        const copyLogsBtn = document.getElementById('copy-logs-btn');
        const runTestsBtn = document.getElementById('run-tests-btn');
        
        // Edit Message Modal
        const editMessageModal = document.getElementById('edit-message-modal');
        const editMessageModalContent = editMessageModal.querySelector('.modal-content');
        const editMessageTextarea = document.getElementById('edit-message-textarea');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        let editingMessageIndex = -1; 

        // --- Application State ---
        let apiKey = '';
        let selectedModel = 'gemini-1.5-pro-latest'; 
        let customInstructions = '';
        let conversation = []; 
        let appLogs = [];
        let currentAttachedImage = { base64: null, mimeType: null, name: null };
        const MAX_CONVERSATION_HISTORY_API = 10; 

        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function appLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' ');
            appLogs.push({ timestamp, type, message });
            if (appLogs.length > 200) appLogs.shift(); 

            const logEntryDiv = document.createElement('div');
            logEntryDiv.classList.add('log-entry', type);
            logEntryDiv.innerHTML = `<strong>[${timestamp}] [${type.toUpperCase()}]</strong>: ${escapeHtml(message).replace(/\n/g, '<br>')}`;
            if(logOutputArea) logOutputArea.appendChild(logEntryDiv); // Check if logOutputArea exists
            if(logOutputArea) logOutputArea.scrollTop = logOutputArea.scrollHeight;

            switch(type) {
                case 'error': originalConsoleError.apply(console, args); break;
                case 'warn': originalConsoleWarn.apply(console, args); break;
                default: originalConsoleLog.apply(console, args);
            }
        }
        
        console.log = (...args) => { appLog('info', ...args); };
        console.error = (...args) => { appLog('error', ...args); };
        console.warn = (...args) => { appLog('warn', ...args); };

        function escapeHtml(unsafe) {
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function basicMarkdownToHtml(text) {
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>');
            html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>');
            html = html.replace(/~~(.*?)~~/g, '<del>$1</del>');
            html = html.replace(/`([^`]+?)`/g, '<code>$1</code>');
            html = html.replace(/```(\w*)\n([\s\S]*?)\n```/g, (match, lang, code) => `<pre><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre>`);
            html = html.replace(/^(\s*)[-*+]\s+(.*)/gm, (match, indent, item) => `${indent}<li>${item}</li>`);
            html = html.replace(/((?:^\s*<li>.*<\/li>\n?)+)/gm, '<ul>\n$1</ul>\n');
            html = html.replace(/^(\s*)\d+\.\s+(.*)/gm, (match, indent, item) => `${indent}<li>${item}</li>`);
            html = html.replace(/((?:^\s*<li>.*<\/li>\n?)+)/gm, (match, p1, offset, string) => {
                if (!string.substring(0, offset).trim().endsWith('</ol>') && !string.substring(0, offset).trim().endsWith('</ul>')) return '<ol>\n' + match + '</ol>\n';
                return match;
            });
            html = html.replace(/<\/ul>\n<ul>/g, '').replace(/<\/ol>\n<ol>/g, '');
            return html.replace(/\n/g, '<br>');
        }

        function generateMessageId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }

        function displayMessageInChat(msg) {
            const outerWrapper = document.createElement('div'); // New outer wrapper
            outerWrapper.classList.add('message-wrapper', msg.role === 'user' ? 'user' : 'model');
            outerWrapper.dataset.messageId = msg.id;

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('p-3', 'rounded-xl', 'chat-bubble');

            if (msg.imageBase64) {
                const imgElement = document.createElement('img');
                imgElement.src = msg.imageBase64;
                imgElement.alt = "User image";
                imgElement.classList.add('max-w-xs', 'max-h-48', 'rounded-md', 'mb-2', 'border', 'border-gray-300');
                messageDiv.appendChild(imgElement);
            }
            
            const textElement = document.createElement('div');
            if (msg.role === 'model' && !msg.isError) {
                textElement.innerHTML = basicMarkdownToHtml(msg.text || '');
            } else {
                textElement.textContent = msg.text || '';
            }
            messageDiv.appendChild(textElement);
            outerWrapper.appendChild(messageDiv); // Message bubble added to outer wrapper

            const actionsContainer = document.createElement('div');
            actionsContainer.classList.add('message-actions'); // Styling handled by CSS
            
            if (msg.role === 'user') {
                messageDiv.classList.add('bg-blue-600', 'text-white');
                const editBtn = createActionButton('Edit', 'M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125', () => openEditModal(msg.id));
                actionsContainer.appendChild(editBtn);
            } else { 
                if (msg.isError) {
                    messageDiv.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-300');
                } else {
                    messageDiv.classList.add('bg-gray-200', 'text-gray-800');
                    const copyBtn = createActionButton('Copy', 'M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.393-.03.79-.03 1.184 0 1.13.094 1.976 1.057 1.976 2.192V7.5m-9 3c0-1.135.845-2.098 1.976-2.192a48.424 48.424 0 011.184 0c1.13.094 1.976 1.057 1.976 2.192v1.292c0 1.135-.845 2.098-1.976 2.192a48.424 48.424 0 01-1.184 0c-1.13-.094-1.976-1.057-1.976-2.192V10.5zM9 13.5h6m-6 3h6m-6-3h.008v.008H9v-.008zm0 3h.008v.008H9v-.008zm0-3.008h.008v.008H9v-.008z', () => copyToClipboard(msg.text || ''));
                    actionsContainer.appendChild(copyBtn);
                    
                    const lastMessageInChat = conversation[conversation.length -1];
                    if (lastMessageInChat && lastMessageInChat.id === msg.id && !msg.isError) {
                         const regenerateBtn = createActionButton('Regenerate', 'M16.023 9.348h4.992v-.001a.75.75 0 01.75.75c0 .414-.336.75-.75.75h-4.992v5.052c0 .83-.672 1.5-1.5 1.5s-1.5-.67-1.5-1.5v-5.052H4.477c-.83 0-1.5-.672-1.5-1.5s.672-1.5 1.5-1.5h8.496V4.296c0-.83.672-1.5 1.5-1.5s1.5.672 1.5 1.5v5.052z', regenerateLastAIResponse);
                         actionsContainer.appendChild(regenerateBtn);
                    }
                }
            }
            
            if (actionsContainer.hasChildNodes()) { 
                outerWrapper.appendChild(actionsContainer); // Actions added to outer wrapper
            }
            chatHistoryDisplay.appendChild(outerWrapper);
            chatHistoryDisplay.scrollTo({ top: chatHistoryDisplay.scrollHeight, behavior: 'smooth' });
        }
        
        function createActionButton(title, svgPathD, onClickAction) {
            const button = document.createElement('button');
            button.title = title;
            // Removed control-icon class, direct styling via .message-actions button in CSS
            button.classList.add('p-1', 'rounded', 'hover:bg-gray-300'); 
            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-3.5 h-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="${svgPathD}" /></svg>`;
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                onClickAction();
            });
            return button;
        }

        function renderFullChatHistory() {
            chatHistoryDisplay.innerHTML = '';
            conversation.forEach(msg => displayMessageInChat(msg));
        }

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAttachedImage.base64 = e.target.result;
                    currentAttachedImage.mimeType = file.type;
                    currentAttachedImage.name = file.name;
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            }
            imageUploadInput.value = '';
        });

        function renderImagePreview() {
            imagePreviewArea.innerHTML = '';
            if (currentAttachedImage.base64) {
                const container = document.createElement('div');
                container.classList.add('image-preview-container');
                const img = document.createElement('img');
                img.src = currentAttachedImage.base64;
                img.alt = currentAttachedImage.name || "Preview";
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('remove-image-btn');
                removeBtn.innerHTML = '&times;';
                removeBtn.title = "Remove image";
                removeBtn.onclick = () => {
                    currentAttachedImage = { base64: null, mimeType: null, name: null };
                    renderImagePreview();
                };
                container.appendChild(img);
                container.appendChild(removeBtn);
                imagePreviewArea.appendChild(container);
            }
        }

        async function sendMessageToAPI() {
            const messageText = messageInput.value.trim();
            if (!messageText && !currentAttachedImage.base64) return;
            if (!apiKey) {
                addMessageToConversation('model', 'API Key is missing. Please set your API key in Settings.', null, null, true);
                openModal(settingsModal, settingsModalContent);
                return;
            }

            const userMessageId = generateMessageId();
            addMessageToConversation('user', messageText, currentAttachedImage.base64, currentAttachedImage.mimeType, false, userMessageId);
            
            const tempImageBase64 = currentAttachedImage.base64; 
            const tempImageMimeType = currentAttachedImage.mimeType;
            currentAttachedImage = { base64: null, mimeType: null, name: null }; 
            renderImagePreview();
            messageInput.value = '';
            sendBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');
            copyFeedback.textContent = '';

            let apiConversationHistory = [];
            if (customInstructions) {
                 apiConversationHistory.push({ role: "user", parts: [{ text: `System Instructions: ${customInstructions}` }] });
                 apiConversationHistory.push({ role: "model", parts: [{ text: "Understood. I will follow these instructions." }] }); 
            }

            const recentMessagesForApi = conversation
                .slice(-MAX_CONVERSATION_HISTORY_API * 2) 
                .map(msg => {
                    const parts = [];
                    if (msg.text) parts.push({ text: msg.text });
                    if (msg.imageBase64 && msg.role === 'user') { 
                        parts.push({ inlineData: { mimeType: msg.imageMimeType, data: msg.imageBase64.split(',')[1] } });
                    }
                    return { role: msg.role === 'model' ? 'model' : 'user', parts };
                })
                .filter(msg => msg.parts.length > 0); 

            apiConversationHistory = [...apiConversationHistory, ...recentMessagesForApi];

            let effectiveModel = selectedModel;
            if (tempImageBase64 && !selectedModel.includes('1.5-pro')) { 
                console.warn(`Image attached, but current model ${selectedModel} may not be optimal for multimodal. Consider Gemini 1.5 Pro.`);
            }
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${effectiveModel}:generateContent?key=${apiKey}`;
            const payload = { contents: apiConversationHistory, safetySettings: [ /* ... */ ] };

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                if (!response.ok) {
                    let errorMsg = `API request failed: ${response.status}`;
                    if (data && data.error && data.error.message) errorMsg += ` - ${data.error.message}`;
                    throw new Error(errorMsg);
                }
                let botReplyText = 'No valid response from API.';
                let isErrorResponse = true;
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    botReplyText = data.candidates[0].content.parts[0].text;
                    isErrorResponse = false;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    botReplyText = `Request blocked. Reason: ${data.promptFeedback.blockReason}.`;
                    if(data.promptFeedback.safetyRatings) botReplyText += ` Ratings: ${data.promptFeedback.safetyRatings.map(r => `${r.category.replace('HARM_CATEGORY_', '')}: ${r.probability}`).join(', ')}`;
                }
                addMessageToConversation('model', botReplyText, null, null, isErrorResponse);
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToConversation('model', `Error: ${error.message}`, null, null, true);
            } finally {
                sendBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
                loadingIndicator.classList.remove('flex');
                messageInput.focus();
                saveChatState(); 
            }
        }
        
        async function regenerateLastAIResponse() {
            console.info("Attempting to regenerate last AI response.");
            if (conversation.length < 2) {
                console.warn("Not enough history to regenerate.");
                return;
            }
            let lastUserMessageIndex = -1;
            for (let i = conversation.length - 1; i >= 0; i--) {
                if (conversation[i].role === 'user') { lastUserMessageIndex = i; break; }
            }
            if (lastUserMessageIndex === -1) { console.warn("No user message found to regenerate from."); return; }

            conversation = conversation.slice(0, lastUserMessageIndex + 1);
            renderFullChatHistory(); 
            
            sendBtn.disabled = true;
            loadingIndicator.classList.remove('hidden'); loadingIndicator.classList.add('flex');
            copyFeedback.textContent = '';

            let apiConversationHistory = [];
            if (customInstructions) {
                 apiConversationHistory.push({ role: "user", parts: [{ text: `System Instructions: ${customInstructions}` }] });
                 apiConversationHistory.push({ role: "model", parts: [{ text: "Understood." }] });
            }
            const recentMessagesForApi = conversation.slice(-MAX_CONVERSATION_HISTORY_API * 2)
                .map(msg => {
                    const parts = [];
                    if (msg.text) parts.push({ text: msg.text });
                    if (msg.imageBase64 && msg.role === 'user') parts.push({ inlineData: { mimeType: msg.imageMimeType, data: msg.imageBase64.split(',')[1] } });
                    return { role: msg.role === 'model' ? 'model' : 'user', parts };
                }).filter(msg => msg.parts.length > 0);
            apiConversationHistory = [...apiConversationHistory, ...recentMessagesForApi];
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
            const payload = { contents: apiConversationHistory, safetySettings: [ /* ... */ ] };

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.error?.message || `API Error ${response.status}`); }
                let botReplyText = 'No valid response from API.';
                let isErrorResponse = true;
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    botReplyText = data.candidates[0].content.parts[0].text;
                    isErrorResponse = false;
                } else if (data.promptFeedback?.blockReason) {
                    botReplyText = `Request blocked. Reason: ${data.promptFeedback.blockReason}.`;
                }
                addMessageToConversation('model', botReplyText, null, null, isErrorResponse);
            } catch (error) {
                console.error('Error regenerating response:', error);
                addMessageToConversation('model', `Error regenerating: ${error.message}`, null, null, true);
            } finally {
                sendBtn.disabled = false;
                loadingIndicator.classList.add('hidden'); loadingIndicator.classList.remove('flex');
                messageInput.focus();
                saveChatState();
            }
        }

        function openEditModal(messageId) {
            editingMessageIndex = conversation.findIndex(msg => msg.id === messageId);
            if (editingMessageIndex === -1 || conversation[editingMessageIndex].role !== 'user') {
                console.error("Cannot edit this message or message not found.");
                return;
            }
            editMessageTextarea.value = conversation[editingMessageIndex].text;
            openModal(editMessageModal, editMessageModalContent);
        }

        saveEditBtn.addEventListener('click', () => {
            if (editingMessageIndex === -1) return;
            const newText = editMessageTextarea.value.trim();
            const originalMessage = conversation[editingMessageIndex];
            if (newText === originalMessage.text) { closeModal(editMessageModal, editMessageModalContent); return; }

            conversation = conversation.slice(0, editingMessageIndex);
            const editedMessageId = generateMessageId();
            addMessageToConversation('user', newText, originalMessage.imageBase64, originalMessage.imageMimeType, false, editedMessageId);
            closeModal(editMessageModal, editMessageModalContent);
            
            sendBtn.disabled = true;
            loadingIndicator.classList.remove('hidden'); loadingIndicator.classList.add('flex');
            copyFeedback.textContent = '';

            let apiConversationHistory = [];
            if (customInstructions) {
                 apiConversationHistory.push({ role: "user", parts: [{ text: `System Instructions: ${customInstructions}` }] });
                 apiConversationHistory.push({ role: "model", parts: [{ text: "Understood." }] });
            }
            const recentMessagesForApi = conversation.slice(-MAX_CONVERSATION_HISTORY_API * 2)
                .map(msg => {
                    const parts = [];
                    if (msg.text) parts.push({ text: msg.text });
                    if (msg.imageBase64 && msg.role === 'user') parts.push({ inlineData: { mimeType: msg.imageMimeType, data: msg.imageBase64.split(',')[1] } });
                    return { role: msg.role === 'model' ? 'model' : 'user', parts };
                }).filter(msg => msg.parts.length > 0);
            apiConversationHistory = [...apiConversationHistory, ...recentMessagesForApi];
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
            const payload = { contents: apiConversationHistory, safetySettings: [ /* ... */ ] };

            fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                .then(({ ok, status, data }) => {
                    if (!ok) {
                        let errorMsg = `API request failed: ${status}`;
                        if (data && data.error && data.error.message) errorMsg += ` - ${data.error.message}`;
                        throw new Error(errorMsg);
                    }
                    let botReplyText = 'No valid response from API.';
                    let isErrorResponse = true;
                    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                        botReplyText = data.candidates[0].content.parts[0].text;
                        isErrorResponse = false;
                    } else if (data.promptFeedback?.blockReason) {
                        botReplyText = `Request blocked. Reason: ${data.promptFeedback.blockReason}.`;
                    }
                    addMessageToConversation('model', botReplyText, null, null, isErrorResponse);
                })
                .catch(error => {
                    console.error('Error sending edited message:', error);
                    addMessageToConversation('model', `Error: ${error.message}`, null, null, true);
                })
                .finally(() => {
                    sendBtn.disabled = false;
                    loadingIndicator.classList.add('hidden'); loadingIndicator.classList.remove('flex');
                    messageInput.focus();
                    saveChatState();
                });
            editingMessageIndex = -1;
        });
        cancelEditBtn.addEventListener('click', () => closeModal(editMessageModal, editMessageModalContent));

        function addMessageToConversation(role, text, imageBase64 = null, imageMimeType = null, isError = false, id = null) {
            const messageId = id || generateMessageId();
            const message = { id: messageId, role, text, imageBase64, imageMimeType, isError };
            conversation.push(message);
            renderFullChatHistory(); 
            return messageId;
        }

        function saveChatState() {
            try {
                const state = { apiKey, selectedModel, customInstructions, conversation };
                localStorage.setItem('geminiAdvancedChatState', JSON.stringify(state));
                console.info('Chat state saved.');
            } catch (e) {
                console.error('Failed to save chat state to localStorage:', e);
            }
        }

        function loadChatState() {
            try {
                const savedState = localStorage.getItem('geminiAdvancedChatState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    apiKey = state.apiKey || '';
                    selectedModel = state.selectedModel || 'gemini-1.5-pro-latest';
                    customInstructions = state.customInstructions || '';
                    conversation = state.conversation || [];
                    console.info('Chat state loaded.');
                }
            } catch (e) {
                console.error('Failed to load chat state from localStorage:', e);
                localStorage.removeItem('geminiAdvancedChatState'); 
            }
        }
        
        sendBtn.addEventListener('click', sendMessageToAPI);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessageToAPI(); } });

        function openModal(modalElement, modalContentElement) {
            modalElement.classList.remove('hidden'); modalElement.classList.add('flex');
            setTimeout(() => { modalContentElement.classList.remove('scale-95', 'opacity-0'); modalContentElement.classList.add('scale-100', 'opacity-100'); }, 10);
            const focusable = modalContentElement.querySelector('input, select, button, textarea');
            if (focusable) focusable.focus();
        }
        function closeModal(modalElement, modalContentElement) {
            modalContentElement.classList.remove('scale-100', 'opacity-100'); modalContentElement.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modalElement.classList.add('hidden'); modalElement.classList.remove('flex'); }, 300);
        }

        settingsBtn.addEventListener('click', () => {
            apiKeyInput.value = apiKey;
            modelSelect.value = selectedModel;
            customInstructionsInput.value = customInstructions;
            openModal(settingsModal, settingsModalContent);
        });
        closeSettingsBtn.addEventListener('click', () => closeModal(settingsModal, settingsModalContent));
        saveSettingsBtn.addEventListener('click', () => {
            const newApiKey = apiKeyInput.value.trim();
            if (!newApiKey) { addMessageToConversation('model', "API Key cannot be empty.", null, null, true); apiKeyInput.focus(); return; }
            apiKey = newApiKey;
            selectedModel = modelSelect.value;
            customInstructions = customInstructionsInput.value.trim();
            saveChatState();
            closeModal(settingsModal, settingsModalContent);
            addMessageToConversation('model', `Settings saved. Model: ${selectedModel}. Custom instructions updated.`, null, null, false);
        });
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeModal(settingsModal, settingsModalContent); });

        clearChatBtn.addEventListener('click', () => openModal(confirmClearModal, confirmClearModalContent));
        cancelClearBtn.addEventListener('click', () => closeModal(confirmClearModal, confirmClearModalContent));
        
        function clearCurrentChatUIAndState() {
            conversation = [];
            chatHistoryDisplay.innerHTML = '';
            currentAttachedImage = { base64: null, mimeType: null, name: null };
            renderImagePreview();
            saveChatState(); 
            addMessageToConversation('model', 'New chat started.', null, null, false);
            messageInput.focus();
        }

        confirmClearActionBtn.addEventListener('click', () => {
            clearCurrentChatUIAndState();
            closeModal(confirmClearModal, confirmClearModalContent);
        });

        saveNewBtn.addEventListener('click', () => {
            if (conversation.length > 0) {
                try {
                    let archivedChats = JSON.parse(localStorage.getItem('geminiArchivedChats') || '[]');
                    const chatToSave = {
                        id: Date.now().toString(),
                        name: `Chat ${new Date().toLocaleString()}`,
                        conversation: [...conversation], // Save a copy
                        customInstructions, // Save custom instructions with the chat
                        model: selectedModel, // Save model with the chat
                        timestamp: new Date().toISOString()
                    };
                    archivedChats.push(chatToSave);
                    localStorage.setItem('geminiArchivedChats', JSON.stringify(archivedChats));
                    console.info(`Chat (ID: ${chatToSave.id}) archived successfully. Total archived: ${archivedChats.length}`);
                } catch (e) {
                    console.error("Failed to archive chat:", e);
                }
            }
            clearCurrentChatUIAndState();
            closeModal(confirmClearModal, confirmClearModalContent);
        });

        confirmClearModal.addEventListener('click', (e) => { if (e.target === confirmClearModal) closeModal(confirmClearModal, confirmClearModalContent); });

        viewLogsBtn.addEventListener('click', () => openModal(logsModal, logsModalContent));
        closeLogsBtn.addEventListener('click', () => closeModal(logsModal, logsModalContent));
        copyLogsBtn.addEventListener('click', () => {
            const logText = appLogs.map(log => `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`).join('\n');
            copyToClipboard(logText, "Logs copied to clipboard!");
        });
        logsModal.addEventListener('click', (e) => { if (e.target === logsModal) closeModal(logsModal, logsModalContent); });

        function copyToClipboard(text, successMessage = "Copied!") {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copyFeedback.textContent = successMessage;
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
                originalConsoleLog.call(console, successMessage); // Use original to avoid appLog recursion
            } catch (err) {
                originalConsoleError.call(console, 'Failed to copy: ', err); // Use original
                copyFeedback.textContent = 'Copy failed!';
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            }
        }
        
        runTestsBtn.addEventListener('click', async () => {
            console.info("--- Starting Basic Tests ---");
            console.info("Test 1: Settings Save/Load");
            const oldApiKey = apiKey; const oldModel = selectedModel; const oldInstructions = customInstructions; const oldConversation = [...conversation];
            localStorage.setItem('geminiAdvancedChatState', JSON.stringify({ apiKey: 'test-key', selectedModel: 'gemma-3n', customInstructions: 'test-instr', conversation: [{id:'test', role:'user', text:'hello'}] }));
            loadChatState();
            if (apiKey === 'test-key' && selectedModel === 'gemma-3n' && customInstructions === 'test-instr' && conversation.length === 1 && conversation[0].text === 'hello') {
                console.info("Test 1 PASSED: Settings load correctly.");
            } else {
                console.error("Test 1 FAILED: Settings did not load as expected.", {expectedKey: 'test-key', actualKey: apiKey});
            }
            apiKey = oldApiKey; selectedModel = oldModel; customInstructions = oldInstructions; conversation = oldConversation;
            saveChatState(); 
            apiKeyInput.value = apiKey; modelSelect.value = selectedModel; customInstructionsInput.value = customInstructions;

            console.info("Test 2: API Connectivity (Simple Text Prompt)");
            if (!apiKey) {
                console.warn("Test 2 SKIPPED: API Key not set.");
            } else {
                const testPrompt = "Hello! This is a test prompt. Respond with 'Test OK'.";
                const testApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                const testPayload = { contents: [{ role: "user", parts: [{ text: testPrompt }] }] };
                try {
                    const response = await fetch(testApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(testPayload) });
                    const data = await response.json();
                    if (response.ok && data.candidates && data.candidates[0].content.parts[0].text.includes("Test OK")) {
                        console.info("Test 2 PASSED: API responded successfully. Response: " + data.candidates[0].content.parts[0].text);
                    } else {
                        console.error("Test 2 FAILED: API did not respond as expected.", data);
                    }
                } catch (err) {
                    console.error("Test 2 FAILED: API call error.", err.message);
                }
            }
            console.info("--- Basic Tests Finished ---");
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (settingsModal.classList.contains('flex')) closeModal(settingsModal, settingsModalContent);
                if (confirmClearModal.classList.contains('flex')) closeModal(confirmClearModal, confirmClearModalContent);
                if (logsModal.classList.contains('flex')) closeModal(logsModal, logsModalContent);
                if (editMessageModal.classList.contains('flex')) closeModal(editMessageModal, editMessageModalContent);
            }
        });

        function initializeApp() {
            originalConsoleLog.call(console, "Initializing Chat Application..."); 
            loadChatState();
            apiKeyInput.value = apiKey;
            modelSelect.value = selectedModel;
            customInstructionsInput.value = customInstructions;
            renderFullChatHistory();

            if (!apiKey) {
                addMessageToConversation('model', "Welcome! Please configure your Gemini API key in Settings to start.", null, null, false);
                openModal(settingsModal, settingsModalContent);
            } else {
                if(conversation.length === 0) { 
                    addMessageToConversation('model', `Welcome back! Model: ${selectedModel}. Custom Instructions: ${customInstructions ? 'Set' : 'Not Set'}.`, null, null, false);
                }
            }
            messageInput.focus();
            console.info("Application Initialized."); 
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
